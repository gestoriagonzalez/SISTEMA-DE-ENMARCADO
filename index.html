<script>
document.addEventListener("DOMContentLoaded", () => {

// ------------------------- CONFIG -------------------------
const basePath = "./pdf/"; 
const marcoFile = "MARCO_ACTA.pdf";

const estadosValidos = [
  "AGUASCALIENTES", "BAJA CALIFORNIA", "BAJA CALIFORNIA SUR",
  "CAMPECHE", "CHIAPAS", "CHIHUAHUA", "CIUDAD DE MEXICO",
  "COAHUILA", "COLIMA", "DURANGO", "GUANAJUATO", "GUERRERO",
  "HIDALGO", "JALISCO", "MEXICO", "MICHOACAN", "MORELOS",
  "NAYARIT", "NUEVO LEON", "OAXACA", "PUEBLA", "QUERETARO",
  "QUINTANA ROO", "SAN LUIS POTOSI", "SINALOA", "SONORA",
  "TABASCO", "TAMAULIPAS", "TLAXCALA", "VERACRUZ",
  "YUCATAN", "ZACATECAS"
];

// ------------------------- DETECCIÓN ESTADO -------------------------
function detectEstado(text) {
  const lines = text.toUpperCase().split(/\r?\n/);

  for (let i = 0; i < lines.length - 1; i++) {
    if (lines[i].includes("ENTIDAD DE REGISTRO")) {
      const estadoLinea = lines[i + 1].trim();
      return estadosValidos.find(est => estadoLinea.includes(est)) || null;
    }
  }
  return null;
}

async function extractTextFirstPage(file) {
  const buffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: buffer }).promise;
  const page = await pdf.getPage(1);
  const text = await page.getTextContent();
  return text.items.map(t => t.str).join("\n");
}

// ------------------------- FUNCIONES PDF -------------------------
async function mergePDF(baseBytes) {
  const { PDFDocument } = PDFLib;

  const marcoBytes = await fetch(basePath + marcoFile).then(r => r.arrayBuffer());
  const basePdf = await PDFDocument.load(baseBytes);
  const marcoPdf = await PDFDocument.load(marcoBytes);
  const result = await PDFDocument.create();

  const [basePage] = await result.copyPages(basePdf, [0]);
  const [marcoPage] = await result.copyPages(marcoPdf, [0]);

  const { width, height } = basePage.getSize();
  const page = result.addPage([width, height]);

  page.drawPage(await page.doc.embedPage(marcoPage), { x:0, y:0, width, height });
  page.drawPage(await page.doc.embedPage(basePage), { x:0, y:0, width, height });

  return result;
}

async function mergePDFWithReverso(bytes, estado) {
  const result = await mergePDF(bytes);
  const revBytes = await fetch(basePath + estado + ".pdf").then(r => r.arrayBuffer());
  const revPdf = await PDFLib.PDFDocument.load(revBytes);
  const [revPage] = await result.copyPages(revPdf, [0]);
  result.addPage(revPage);
  return result;
}

async function download(pdf, name) {
  const bytes = await pdf.save();
  const url = URL.createObjectURL(new Blob([bytes], { type:"application/pdf" }));
  const a = document.createElement("a");
  a.href = url;
  a.download = name;
  a.click();
  URL.revokeObjectURL(url);
}

// ------------------------- BOTÓN SIN REVERSO -------------------------
document.getElementById("mergeBtn").addEventListener("click", async () => {
  const input = document.getElementById("baseFiles");
  const status = document.getElementById("status");

  if (!input.files.length) return alert("Selecciona al menos un PDF.");

  status.textContent = "Procesando documentos...";
  let count = 0;

  for (const file of input.files) {
    const bytes = await file.arrayBuffer();
    const pdf = await mergePDF(bytes);
    await download(pdf, file.name.replace(/\.pdf$/i, "") + " - ENMARCADO.pdf");
    count++;
  }

  status.textContent = `✔ ${count} PDF(s) procesados correctamente.`;
});

// ------------------------- BOTÓN CON REVERSO -------------------------
document.getElementById("mergeWithReversoBtn").addEventListener("click", async () => {
  const input = document.getElementById("baseFilesWithReverso");
  const status = document.getElementById("status");

  if (!input.files.length) return alert("Selecciona al menos un PDF.");

  status.textContent = "Leyendo información del acta...";
  let count = 0;

  for (const file of input.files) {
    const text = await extractTextFirstPage(file);
    const estado = detectEstado(text);

    if (!estado) {
      alert(`❌ Estado no detectado en: ${file.name}`);
      continue;
    }

    const bytes = await file.arrayBuffer();
    const pdf = await mergePDFWithReverso(bytes, estado);
    await download(pdf, file.name.replace(/\.pdf$/i, "") + " - CON REVERSO.pdf");
    count++;
  }

  status.textContent = `✔ ${count} PDF(s) con reverso procesados.`;
});

}); // FIN DOMContentLoaded
</script>










