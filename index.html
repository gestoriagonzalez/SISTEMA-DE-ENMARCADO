<script>
// ------------------------- CONFIG -------------------------
const basePath = "./pdf/"; // Carpeta donde están el marco y los reversos
const marcoFile = "MARCO_ACTA.pdf";

// Lista de estados soportados (como deben llamarse los reversos)
const estadosValidos = [
  "AGUASCALIENTES", "BAJA CALIFORNIA", "BAJA CALIFORNIA SUR",
  "CAMPECHE", "CHIAPAS", "CHIHUAHUA", "CIUDAD DE MEXICO",
  "COAHUILA", "COLIMA", "DURANGO", "GUANAJUATO", "GUERRERO",
  "HIDALGO", "JALISCO", "MEXICO", "MICHOACAN", "MORELOS",
  "NAYARIT", "NUEVO LEON", "OAXACA", "PUEBLA", "QUERETARO",
  "QUINTANA ROO", "SAN LUIS POTOSI", "SINALOA", "SONORA",
  "TABASCO", "TAMAULIPAS", "TLAXCALA", "VERACRUZ",
  "YUCATAN", "ZACATECAS"
];

// ------------------------- DETECCIÓN ESTADO -------------------------
function detectEstado(text) {
  const lines = text.toUpperCase().split(/\r?\n/);

  for (let i = 0; i < lines.length; i++) {
    if (lines[i].includes("ENTIDAD DE REGISTRO")) {
      const estadoLinea = lines[i + 1]?.trim();
      if (!estadoLinea) return null;

      const estadoDetectado = estadosValidos.find(est =>
        estadoLinea.includes(est)
      );
      return estadoDetectado || null;
    }
  }
  return null;
}

async function extractTextFirstPage(file) {
  const arrayBuffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
  const page = await pdf.getPage(1);
  const text = await page.getTextContent();
  return text.items.map(t => t.str).join("\n");
}

// ------------------------- FUNCIONES PDF -------------------------
async function mergePDF(baseBytes) {
  const { PDFDocument } = PDFLib;

  const marcoBytes = await fetch(basePath + marcoFile).then(r => r.arrayBuffer());
  const basePdf = await PDFDocument.load(baseBytes);
  const marcoPdf = await PDFDocument.load(marcoBytes);
  const resultPdf = await PDFDocument.create();

  const [basePage] = await resultPdf.copyPages(basePdf, [0]);
  const [marcoPage] = await resultPdf.copyPages(marcoPdf, [0]);

  const { width, height } = basePage.getSize();
  const page = resultPdf.addPage([width, height]);

  page.drawPage(await page.doc.embedPage(marcoPage), { x: 0, y: 0, width, height });
  page.drawPage(await page.doc.embedPage(basePage), { x: 0, y: 0, width, height });

  return resultPdf;
}

async function mergePDFWithReverso(baseBytes, estado) {
  const resultPdf = await mergePDF(baseBytes);
  const reversoBytes = await fetch(basePath + estado + ".pdf").then(r => r.arrayBuffer());
  const reversoPdf = await PDFLib.PDFDocument.load(reversoBytes);
  const [rp] = await resultPdf.copyPages(reversoPdf, [0]);
  resultPdf.addPage(rp);
  return resultPdf;
}

async function download(pdfDoc, name) {
  const pdfBytes = await pdfDoc.save();
  const url = URL.createObjectURL(new Blob([pdfBytes], { type: "application/pdf" }));
  const a = document.createElement("a");
  a.href = url;
  a.download = name;
  a.click();
  URL.revokeObjectURL(url);
}

// ------------------------- BOTÓN SIN REVERSO -------------------------
document.getElementById("mergeBtn").addEventListener("click", async () => {
  const input = document.getElementById("baseFiles");
  const status = document.getElementById("status");
  const btn = document.getElementById("mergeBtn");

  if (!input.files.length) return alert("Selecciona al menos un PDF.");

  btn.disabled = true;
  let count = 0;

  for (const file of input.files) {
    status.textContent = `Procesando: ${file.name}`;

    const bytes = await file.arrayBuffer();
    const pdf = await mergePDF(bytes);
    await download(pdf, file.name.replace(/\.pdf$/i, "") + " (1).pdf");

    count++;
  }

  status.textContent = `✅ ${count} PDFs enmarcados correctamente.`;
  btn.disabled = false;
});

// ------------------------- BOTÓN CON REVERSO -------------------------
document.getElementById("mergeWithReversoBtn").addEventListener("click", async () => {
  const input = document.getElementById("baseFilesWithReverso");
  const status = document.getElementById("status");
  const btn = document.getElementById("mergeWithReversoBtn");

  if (!input.files.length) return alert("Selecciona al menos un PDF.");

  btn.disabled = true;
  let count = 0;

  for (const file of input.files) {
    status.textContent = `Leyendo: ${file.name}`;

    const text = await extractTextFirstPage(file);
    const estado = detectEstado(text);

    if (!estado) {
      alert(`No se detectó el estado en:\n${file.name}`);
      continue;
    }

    const bytes = await file.arrayBuffer();
    const pdf = await mergePDFWithReverso(bytes, estado);
    await download(pdf, file.name.replace(/\.pdf$/i, "") + " (1).pdf");

    count++;
  }

  status.textContent = `✅ ${count} PDFs con reverso procesados correctamente.`;
  btn.disabled = false;
});
</script>








