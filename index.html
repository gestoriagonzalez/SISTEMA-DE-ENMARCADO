<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GESTORÍA GONZÁLEZ - ENMARCADO MÚLTIPLE</title>

<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>

<style>
  body { font-family: Arial, sans-serif; background:#f6f8fa; padding:24px; }
  .card { background:#fff; border-radius:12px; padding:32px; max-width:800px; margin:auto; box-shadow:0 8px 25px rgba(0,0,0,0.12); text-align:center; }
  h2 { color:#1a237e; margin-bottom:20px; }
  p { line-height:1.6; color:#333; }
  label { display:block; margin:24px 0 8px; font-weight:bold; font-size:17px; color:#222; }
  input { padding:14px; font-size:16px; border-radius:8px; border:1px solid #ccc; width:100%; box-sizing:border-box; }
  button { background:#007bff; color:white; border:none; padding:16px 32px; font-size:18px; font-weight:bold; border-radius:10px; cursor:pointer; margin-top:30px; }
  button:hover:not(:disabled) { background:#0056b3; }
  button:disabled { background:#999; cursor:not-allowed; }
  #status { margin-top:25px; font-weight:bold; font-size:19px; min-height:30px; }
  #progress { margin-top:10px; color:#555; font-size:15px; }
</style>
</head>
<body>

<div class="card">
  <h2>GESTORÍA GONZÁLEZ</h2>
  <h3>Sistema de Enmarcado Automático Múltiple</h3>
  <p>Selecciona <strong>todas las actas que quieras enmarcar</strong> (puedes seleccionar 1, 10 o 100 a la vez).</p>
  <p>El marco y el reverso se aplican automáticamente según el estado detectado.</p>

  <label>Actas a enmarcar (múltiples archivos, sin reverso):</label>
  <input id="baseFiles" type="file" accept="application/pdf" multiple>
  <button id="mergeBtn">GENERAR TODOS LOS PDFs ENMARCADOS</button>

  <hr style="margin:30px 0;">

  <label>Actas a enmarcar y agregar reverso automáticamente:</label>
  <input id="baseFilesWithReverso" type="file" accept="application/pdf" multiple>
  <button id="mergeWithReversoBtn">GENERAR PDF CON REVERSO AUTOMÁTICO</button>

  <div id="status">Listo para procesar</div>
  <div id="progress"></div>
</div>

<script>
// Lista oficial de estados
const stateNames = [
  "AGUASCALIENTES","BAJA CALIFORNIA","BAJA CALIFORNIA SUR","CAMPECHE",
  "CHIAPAS","CHIHUAHUA","COAHUILA","COLIMA","CIUDAD DE MEXICO","CDMX",
  "DURANGO","GUANAJUATO","GUERRERO","HIDALGO","JALISCO",
  "MEXICO","MICHOACAN","MORELOS","NAYARIT","NUEVO LEON",
  "OAXACA","PUEBLA","QUERETARO","QUINTANA ROO","SAN LUIS POTOSI",
  "SINALOA","SONORA","TABASCO","TAMAULIPAS","TLAXCALA",
  "VERACRUZ","YUCATAN","ZACATECAS"
];

const basePath = "./pdf/";

// --------------------- FUNCIONES ---------------------
async function embedMarco(baseBytes) {
  const { PDFDocument } = PDFLib;

  const marcoBytes = await fetch(basePath + encodeURIComponent("MARCO ACTA.pdf")).then(r => r.arrayBuffer());

  const basePDF = await PDFDocument.load(baseBytes);
  const marcoPDF = await PDFDocument.load(marcoBytes);
  const resultPDF = await PDFDocument.create();

  const [marcoPage] = await resultPDF.copyPages(marcoPDF, [0]);
  resultPDF.addPage(marcoPage);

  const [pageBase] = await resultPDF.copyPages(basePDF, [0]);
  resultPDF.addPage(pageBase);

  return resultPDF;
}

async function addReverso(resultPDF, estado){
  const revPath = basePath + encodeURIComponent(estado + ".pdf");
  try {
    const revBytes = await fetch(revPath).then(r => {
      if (!r.ok) throw new Error();
      return r.arrayBuffer();
    });
    const { PDFDocument } = PDFLib;
    const reversoPDF = await PDFDocument.load(revBytes);
    const [revPage] = await resultPDF.copyPages(reversoPDF, [0]);
    resultPDF.addPage(revPage);
    return true;
  } catch {
    return false;
  }
}

async function downloadPDF(pdfDoc, name){
  const pdfBytes = await pdfDoc.save();
  const blob = new Blob([pdfBytes], { type:"application/pdf" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = name;
  a.click();
  URL.revokeObjectURL(url);
}

// ------------------ BOTÓN ENMARCADO SIMPLE ------------------
document.getElementById("mergeBtn").addEventListener("click", async () => {
  const input = document.getElementById("baseFiles");
  if(input.files.length === 0) return alert("Selecciona al menos 1 PDF.");

  const files = Array.from(input.files);
  document.getElementById("mergeBtn").disabled = true;
  let processed = 0;

  for(const file of files){
    document.getElementById("status").textContent = `Procesando: ${file.name}`;
    document.getElementById("progress").textContent = `${processed+1} de ${files.length}`;

    const resultPDF = await embedMarco(await file.arrayBuffer());
    await downloadPDF(resultPDF, file.name.replace(/\.pdf$/i,"") + " - ENMARCADO.pdf");

    processed++;
  }

  document.getElementById("status").textContent = `✔ ¡Proceso terminado!`;
  document.getElementById("progress").textContent = "";
  document.getElementById("mergeBtn").disabled = false;
});

// ------------------ BOTÓN ENMARCADO + REVERSO ------------------
document.getElementById("mergeWithReversoBtn").addEventListener("click", async () => {
  const input = document.getElementById("baseFilesWithReverso");
  if(input.files.length === 0) return alert("Selecciona al menos 1 PDF.");

  const files = Array.from(input.files);
  document.getElementById("mergeWithReversoBtn").disabled = true;
  let processed = 0;
  let missing = [];

  for(const file of files){
    const nameUpper = file.name.toUpperCase();
    const estado = stateNames.find(st => nameUpper.includes(st));

    if(!estado){
      missing.push(file.name + " (estado no detectado)");
      continue;
    }

    document.getElementById("status").textContent = `Procesando: ${file.name}`;
    document.getElementById("progress").textContent = `${processed+1} de ${files.length}`;

    const resultPDF = await embedMarco(await file.arrayBuffer());
    const ok = await addReverso(resultPDF, estado);
    if(!ok) missing.push(file.name + " (sin reverso)");

    await downloadPDF(resultPDF, file.name.replace(/\.pdf$/i,"") + " - ENMARCADO.pdf");

    processed++;
  }

  let msg = `✔ ¡Proceso terminado! ${processed} archivos generados.`;
  if(missing.length) msg += `\n⚠ Archivos con advertencias:\n• ` + missing.join("\n• ");
  alert(msg);

  document.getElementById("status").textContent = "✔ Listo para procesar";
  document.getElementById("progress").textContent = "";
  document.getElementById("mergeWithReversoBtn").disabled = false;
});
</script>

</body>
</html>







