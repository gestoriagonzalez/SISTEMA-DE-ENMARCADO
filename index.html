<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GESTORÍA GONZÁLEZ</title>
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:0; }
  #loginModal {
    position: fixed; top:0; left:0; width:100%; height:100%;
    background: rgba(0,0,0,0.75); display: flex; justify-content: center; align-items: center; z-index:9999;
  }
  #loginBox {
    background:#fff; padding:40px 30px; border-radius:12px; width:380px; text-align:center;
  }
  #loginBox input { width:90%; padding:12px; margin:8px 0; border:1px solid #ccc; border-radius:8px; font-size:14px;}
  #loginBox button { width:95%; padding:12px; background:#007BFF; border:none; color:#fff; font-size:16px; border-radius:8px; cursor:pointer; margin-top:10px;}
  #loginBox button:hover { background:#0056b3; }
  #errorMsg { color:red; margin-top:10px; }
  
  #adminPanel {
    display:none; border:2px solid #007BFF; padding:20px; margin:20px; border-radius:10px; background:#f1f8ff;
  }
  #adminPanel input { display:block; width:90%; margin:5px 0; padding:8px; border:1px solid #ccc; border-radius:6px;}
  #adminPanel button { padding:10px 15px; margin-top:10px; background:#007BFF; color:#fff; border:none; border-radius:6px; cursor:pointer;}
  #adminPanel button:hover { background:#0056b3; }
  #successMsg { color:green; margin-top:8px; }
  #userList { margin-top:10px; font-size:14px; }
</style>
</head>
<body>

<div id="<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>GESTORÍA GONZÁLEZ - ENMARCADO MÚLTIPLE</title>

<!-- PDF-Lib -->
<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
</script>

<style>
  body { font-family: Arial, sans-serif; background:#f6f8fa; padding:24px; }
  .card { background:#fff; border-radius:12px; padding:32px; max-width:800px; margin:auto; box-shadow:0 8px 25px rgba(0,0,0,0.12); text-align:center; }
  h2 { color:#1a237e; margin-bottom:20px; }
  h3 { margin-bottom:20px; color:#333; }
  p { line-height:1.6; color:#333; }
  label { display:block; margin:24px 0 8px; font-weight:bold; font-size:17px; color:#222; }
  input { padding:14px; font-size:16px; border-radius:8px; border:1px solid #ccc; width:100%; box-sizing:border-box; }
  button { background:#007bff; color:white; border:none; padding:16px 32px; font-size:18px; font-weight:bold; border-radius:10px; cursor:pointer; margin-top:30px; }
  button:hover:not(:disabled) { background:#0056b3; }
  button:disabled { background:#999; cursor:not-allowed; }
  #status { margin-top:25px; font-weight:bold; font-size:19px; min-height:30px; }
  #progress { margin-top:10px; color:#555; font-size:15px; }
  hr { margin:30px 0; }
</style>
</head>
<body>

<div class="card">
  <h2>GESTORÍA GONZÁLEZ</h2>
  <h3>Sistema de Enmarcado Automático Múltiple</h3>
  <p>Selecciona <strong>todas las actas que quieras enmarcar</strong> (puedes seleccionar 1, 10 o 100 de golpe).</p>
  <p>El marco y el reverso se aplican automáticamente según el estado detectado.</p>

  <label>Actas a enmarcar (múltiples archivos, sin reverso):</label>
  <input id="baseFiles" type="file" accept="application/pdf" multiple>
  <button id="mergeBtn">GENERAR TODOS LOS PDFs ENMARCADOS</button>

  <hr>

  <label>Actas a enmarcar y agregar reverso automáticamente:</label>
  <input id="baseFilesWithReverso" type="file" accept="application/pdf" multiple>
  <button id="mergeWithReversoBtn">GENERAR PDF CON REVERSO AUTOMÁTICO</button>

  <div id="status">Listo para procesar</div>
  <div id="progress"></div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  const basePath = "/public/pdf/"; // ✅ Ruta corregida para Vercel
  const marcoFile = "MARCO_ACTA.pdf";

  const estadosValidos = [
    "AGUASCALIENTES", "BAJA CALIFORNIA", "BAJA CALIFORNIA SUR",
    "CAMPECHE", "CHIAPAS", "CHIHUAHUA", "CIUDAD DE MEXICO",
    "COAHUILA", "COLIMA", "DURANGO", "GUANAJUATO", "GUERRERO",
    "HIDALGO", "JALISCO", "MEXICO", "MICHOACAN", "MORELOS",
    "NAYARIT", "NUEVO LEON", "OAXACA", "PUEBLA", "QUERETARO",
    "QUINTANA ROO", "SAN LUIS POTOSI", "SINALOA", "SONORA",
    "TABASCO", "TAMAULIPAS", "TLAXCALA", "VERACRUZ",
    "YUCATAN", "ZACATECAS"
  ];

  function cleanText(str) {
    return str.replace(/\s+/g,' ').trim();
  }

  function detectEstado(text) {
    text = cleanText(text.toUpperCase());
    for (const est of estadosValidos) {
      if (text.includes(est)) return est;
    }
    return null;
  }

  async function extractTextFirstPage(file) {
    const buffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: buffer }).promise;
    const page = await pdf.getPage(1);
    const textContent = await page.getTextContent();
    return textContent.items.map(t => t.str).join(" ");
  }

  async function mergePDF(baseBytes) {
    const { PDFDocument } = PDFLib;
    const marcoBytes = await fetch(basePath + marcoFile).then(r => r.arrayBuffer());
    const basePdf = await PDFDocument.load(baseBytes);
    const marcoPdf = await PDFDocument.load(marcoBytes);
    const result = await PDFDocument.create();

    const [basePage] = await result.copyPages(basePdf, [0]);
    const [marcoPage] = await result.copyPages(marcoPdf, [0]);
    const { width, height } = basePage.getSize();
    const page = result.addPage([width, height]);
    page.drawPage(await page.doc.embedPage(marcoPage), { x:0, y:0, width, height });
    page.drawPage(await page.doc.embedPage(basePage), { x:0, y:0, width, height });

    return result;
  }

  async function mergePDFWithReverso(baseBytes, estado) {
    const result = await mergePDF(baseBytes);
    const revBytes = await fetch(basePath + estado + ".pdf").then(r => r.arrayBuffer());
    const revPdf = await PDFLib.PDFDocument.load(revBytes);
    const [revPage] = await result.copyPages(revPdf, [0]);
    result.addPage(revPage);
    return result;
  }

  async function download(pdf, name) {
    const bytes = await pdf.save();
    const url = URL.createObjectURL(new Blob([bytes], { type:"application/pdf" }));
    const a = document.createElement("a");
    a.href = url;
    a.download = name;
    a.click();
    URL.revokeObjectURL(url);
  }

  // ---------- BOTONES ----------

  document.getElementById("mergeBtn").addEventListener("click", async () => {
    const input = document.getElementById("baseFiles");
    const status = document.getElementById("status");
    if (!input.files.length) return alert("Selecciona al menos un PDF.");

    status.textContent = "Procesando documentos...";
    let count = 0;

    for (const file of input.files) {
      try {
        const bytes = await file.arrayBuffer();
        const pdf = await mergePDF(bytes);
        await download(pdf, file.name.replace(/\.pdf$/i, "") + " - ENMARCADO.pdf");
        count++;
      } catch(err) {
        console.error(err);
        alert("Error al procesar " + file.name + ": " + err.message);
      }
    }

    status.textContent = `✔ ${count} PDF(s) procesados correctamente.`;
  });

  document.getElementById("mergeWithReversoBtn").addEventListener("click", async () => {
    const input = document.getElementById("baseFilesWithReverso");
    const status = document.getElementById("status");
    if (!input.files.length) return alert("Selecciona al menos un PDF.");

    status.textContent = "Leyendo información del acta...";
    let count = 0;

    for (const file of input.files) {
      try {
        const text = await extractTextFirstPage(file);
        const estado = detectEstado(text);
        if (!estado) {
          alert(`❌ Estado no detectado en: ${file.name}`);
          continue;
        }

        const bytes = await file.arrayBuffer();
        const pdf = await mergePDFWithReverso(bytes, estado);
        await download(pdf, file.name.replace(/\.pdf$/i, "") + " - CON REVERSO.pdf");
        count++;
      } catch(err) {
        console.error(err);
        alert("Error en " + file.name + ": " + err.message);
      }
    }

    status.textContent = `✔ ${count} PDF(s) con reverso procesados.`;
  });

});
</script>

</body>
</html>
">
  <!-- Tu HTML funcional -->
  <header>
    <h1>Gestoría González</h1>
  </header>
  <section>
    <p>Contenido funcional de tu página aquí...</p>
  </section>
  <footer>
    <p>© 2025 Gestoría González</p>
  </footer>

  <!-- Panel de administración -->
  <div id="adminPanel">
    <h3>CREAR USUARIOS</h3>
    <input type="text" id="newUser" placeholder="Nombre de usuario">
    <input type="password" id="newPass" placeholder="Contraseña">
    <button onclick="addUser()">Agregar Usuario</button>
    <p id="successMsg"></p>
    <div id="userList"></div>
  </div>
</div>

<div id="loginModal">
  <div id="loginBox">
    <h2>Iniciar Sesión</h2>
    <input type="text" id="username" placeholder="Usuario">
    <input type="password" id="password" placeholder="Contraseña">
    <button onclick="checkLogin()">Entrar</button>
    <p id="errorMsg"></p>
  </div>
</div>

<script>
const modal = document.getElementById('loginModal');
const mainContent = document.getElementById('mainContent');
const adminPanel = document.getElementById('adminPanel');
const errorMsg = document.getElementById('errorMsg');
const successMsg = document.getElementById('successMsg');
const userListDiv = document.getElementById('userList');

mainContent.style.display = 'none';

// Login
async function checkLogin() {
  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value;

  try {
    const res = await fetch('/api/login', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ username, password })
    });
    const data = await res.json();
    if(data.ok){
      modal.style.display = 'none';
      mainContent.style.display = 'block';
      errorMsg.innerText = '';
      if(data.role === 'admin'){
        adminPanel.style.display = 'block';
        loadUsers();
      }
    } else {
      errorMsg.innerText = data.message || 'Login fallido';
    }
  } catch(err){
    console.error(err);
    errorMsg.innerText = 'Error de conexión';
  }
}

// Crear usuario
async function addUser() {
  const username = document.getElementById('newUser').value.trim();
  const password = document.getElementById('newPass').value;
  if(!username || !password){
    successMsg.style.color='red';
    successMsg.innerText = 'Complete ambos campos';
    return;
  }

  try {
    const res = await fetch('/api/users', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ username, password })
    });
    const data = await res.json();
    if(res.ok){
      successMsg.style.color='green';
      successMsg.innerText='Usuario agregado correctamente';
      document.getElementById('newUser').value='';
      document.getElementById('newPass').value='';
      loadUsers();
    } else {
      successMsg.style.color='red';
      successMsg.innerText = data.message;
    }
  } catch(err){
    console.error(err);
    successMsg.style.color='red';
    successMsg.innerText='Error al agregar usuario';
  }
}

// Listar usuarios
async function loadUsers() {
  try{
    const res = await fetch('/api/users');
    const users = await res.json();
    let html = '<strong>Usuarios existentes:</strong><ul>';
    users.forEach(u=>{ html+=`<li>${u.username}</li>`; });
    html+='</ul>';
    userListDiv.innerHTML = html;
  } catch(err){
    console.error(err);
    userListDiv.innerHTML = '<p>Error cargando usuarios</p>';
  }
}

// Enter para login
document.getElementById('password').addEventListener('keyup', e=>{ if(e.key==='Enter') checkLogin(); });
// Enter para agregar usuario
document.getElementById('newPass').addEventListener('keyup', e=>{ if(e.key==='Enter') addUser(); });
</script>

</body>
</html>












