<script>
// ------------------- CONFIGURACIÃ“N -------------------
const basePath = "./pdf/";

// ðŸ‘‡ Estados con su reverso exacto (agrega los que falten)
const reversos = {
  "MEXICO": "MEXICO.pdf",
  "QUINTANA ROO": "QUINTANA ROO.pdf",
  "NUEVO LEON": "NUEVO LEON.pdf",
  "JALISCO": "JALISCO.pdf",
  // AGREGA AQUÃ LOS DEMÃS 28 ESTADOS
};

const MARCO_FILE = "marco acta.pdf";

// Cargar PDF desde carpeta pÃºblica
async function loadPDF(relativePath) {
  const url = basePath + relativePath;
  const res = await fetch(url);
  if (!res.ok) throw new Error(`No se encontrÃ³: ${url}`);
  return new Uint8Array(await res.arrayBuffer());
}

// ------------------- FUNCIONES DE PROCESO -------------------
async function mergePDF(baseFileBytes) {
  const { PDFDocument } = PDFLib;

  const marcoBytes = await loadPDF(MARCO_FILE);
  const basePdf = await PDFDocument.load(baseFileBytes);
  const marcoPdf = await PDFDocument.load(marcoBytes);

  const resultPdf = await PDFDocument.create();

  const [basePage] = await resultPdf.copyPages(basePdf, [0]);
  const [marcoPage] = await resultPdf.copyPages(marcoPdf, [0]);
  const { width, height } = basePage.getSize();

  const newPage = resultPdf.addPage([width, height]);
  newPage.drawPage(await newPage.doc.embedPage(marcoPage), { x: 0, y: 0, width, height });
  newPage.drawPage(await newPage.doc.embedPage(basePage), { x: 0, y: 0, width, height });

  return resultPdf;
}

async function mergePDFWithReverso(baseFileBytes, reversoFileName) {
  const { PDFDocument } = PDFLib;

  const resultPdf = await mergePDF(baseFileBytes);

  const reversoBytes = await loadPDF(reversoFileName);
  const reversoPdf = await PDFDocument.load(reversoBytes);

  const [revPage] = await resultPdf.copyPages(reversoPdf, [0]);
  resultPdf.addPage(revPage);

  return resultPdf;
}

async function downloadPDF(pdfDoc, name) {
  const pdfBytes = await pdfDoc.save();
  const blob = new Blob([pdfBytes], { type: "application/pdf" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = name;
  a.click();
  URL.revokeObjectURL(a.href);
}

async function extractTextFirstPage(file) {
  const arrayBuffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
  const page = await pdf.getPage(1);
  const textContent = await page.getTextContent();
  return textContent.items.map(i => i.str).join(" ");
}

function detectEstado(text) {
  text = text.toUpperCase();
  const key = "ENTIDAD DE REGISTRO";
  const index = text.indexOf(key);
  if (index === -1) return null;

  const part = text.slice(index + key.length).trim();
  const match = part.match(/[A-ZÃ‘ ]{2,}/);
  if (!match) return null;
  
  const candidate = match[0].trim();
  for (const est in reversos) {
    if (candidate.includes(est)) return est;
  }
  return null;
}

// ------------------- EVENTOS -------------------

// Enmarcado simple
document.getElementById("mergeBtn").addEventListener("click", async () => {
  const input = document.getElementById("baseFiles");
  const status = document.getElementById("status");
  const progress = document.getElementById("progress");

  if (!input.files.length) return alert("Selecciona al menos un PDF.");
  const btn = event.target;
  btn.disabled = true;

  for (let i = 0; i < input.files.length; i++) {
    const file = input.files[i];

    status.textContent = `Procesando: ${file.name}`;
    progress.textContent = `Archivo ${i + 1} de ${input.files.length}`;

    const bytes = await file.arrayBuffer();
    const result = await mergePDF(bytes);

    await downloadPDF(result, file.name.replace(/\.pdf$/i, "") + " (1).pdf");
  }

  status.textContent = `âœ” Â¡Listo! ${input.files.length} PDFs enmarcados.`;
  progress.textContent = "";
  btn.disabled = false;
});

// Enmarcado + reverso automÃ¡tico
document.getElementById("mergeWithReversoBtn").addEventListener("click", async () => {
  const input = document.getElementById("baseFilesWithReverso");
  const status = document.getElementById("status");
  const progress = document.getElementById("progress");

  if (!input.files.length) return alert("Selecciona al menos un PDF.");
  const btn = event.target;
  btn.disabled = true;

  for (let i = 0; i < input.files.length; i++) {
    const file = input.files[i];

    status.textContent = `Procesando: ${file.name}`;
    progress.textContent = `Archivo ${i + 1} de ${input.files.length}`;

    const text = await extractTextFirstPage(file);
    const estado = detectEstado(text);
    if (!estado) {
      alert(`âŒ No se detectÃ³ estado en: ${file.name}`);
      continue;
    }

    const bytes = await file.arrayBuffer();
    const result = await mergePDFWithReverso(bytes, reversos[estado]);

    await downloadPDF(result, file.name.replace(/\.pdf$/i, "") + " (1).pdf");
  }

  status.textContent = `âœ” Â¡Listo! ${input.files.length} PDFs con reverso.`;
  progress.textContent = "";
  btn.disabled = false;
});
</script>






